<!DOCTYPE html>
<html lang="de" data-theme="dark">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>LoL Quiz</title>
        <link rel="stylesheet" href="styles.css">
    </head>
<body>
    <h1>LoL Quiz</h1>
    <div class="settings-icon" onclick="toggleSettingsMenu()">⚙️</div>
    <div class="info-icon" onclick="toggleInfoMenu()">ℹ️</div>

    <div class="settings-menu" id="settings-menu">
        <h3>Settings</h3>
        <div id="team-inputs"></div>
        <button onclick="addTeam()">Add Team</button>
        <button onclick="removeTeam()">Remove Team</button>
        <div class="quiz-title-group">
            <input type="text" id="quiz-title-input" placeholder="Enter Quiz Title">
            <button onclick="updateQuizTitle()">Update Title</button>
        </div>
        <button onclick="toggleDarkMode()">Toggle Dark Mode</button>
        <button onclick="resetScores()">Reset Points</button>
        <button onclick="deleteQuestionsCookie()">Delete Questions Cookie</button>
    </div>

    <div class="team-scores">
        <div class="team" id="team1">Team 1: <span id="score1">0</span></div>
        <div class="team" id="team2">Team 2: <span id="score2">0</span></div>
        <div class="team" id="team3">Team 3: <span id="score3">0</span></div>
        <div class="team" id="team4">Team 4: <span id="score4">0</span></div>
    </div>
    <div class="jeopardy-board">
        <!-- Categories and questions will be dynamically loaded here -->
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="popup" id="popup">
        <p id="popup-content"></p>
        <div id="popup-buttons"></div>
        <button id="toggle-answer-button" onclick="toggleAnswer()">Antwort</button>
    </div>

    <div class="info-menu" id="info-menu">
        <h3>Info</h3>
        <p>
            Willkommen zum Quiz!<br>
            - Drag & drop eine <code>question.json</code> Datei irgendwo hin um die Fragen zu laden<br>
            - In den Einstellungen kannst du die Teams anpassen<br>
            - Fragen mit gelben Rand sind Schätzfragen.<br>
            - Das Fragefenster kann jederzeit mit ESC geschlossen werden.<br>
            <br>
            How to Play:<br>
            1. Startreihenfolge durch Zufall/Würfel festlegen.<br>
            2. Spieler wählt eine Frage.<br>
            3. Entweder dürfen die Spieler in Reihenfolge die Frage beantworten.<br>
            3.1 Alternativ mit Buzzer(Discord Soundboard) und wer als erstes buzzert darf antworten.<br>
            3.2 Bei Schätzfragen gibt jeder Spieler eine geheime Schätzung an den Spielleiter.<br>
            4. Wenn Spieler Probleme haben können Hinweise angezeigt werden<br>
            5. Wenn jemand die Frage richtig beantwortet oder jeder eine Schätzung abgegeben hat, kann der Spielleiter die Antwort anzeigen.<br>
            6. Der Spielleiter kann dann die Punkte für die Teams vergeben.<br>
            7. Sollten mehrere Teams die Fragen richtig beantworten bekommen alle Teams die Punkte.<br>
            7.1 Dafür muss der Spielleiter die selbe Frage noch mal aufrufen und den Teams die Punkte geben.<br>
            8. Sollte niemand die Frage richtig beantworten so kann die Frage mit Rechtsklick als Beantwortet markiert werden ohne das ein Team Punkte bekommt.<br>
            8.1 Dazu muss das Fragefenster erst geschlossen werden.<br>
            9. Das Spiel geht weiter bis alle Fragen beantwortet sind.<br>
            <br>
            Have fun!
        </p>
    </div>

    <script>
        let scores = [0];
        let showingAnswer = false;
        let currentQuestion = '';
        let currentAnswer = '';
        let currentQuestionObj = null;
        let teamCount = 4; // Start with 4 teams
        let answeredQuestions = JSON.parse(getCookie('answeredQuestions') || '[]');
        let currentHintIndex = 0;
        let currentHints = [];

        // Load saved scores from cookie
        const savedScores = getCookie('scores');
        if (savedScores) {
            const arr = JSON.parse(savedScores);
            teamCount = arr.length; // set teamCount based on saved scores

            const teamScores = document.querySelector('.team-scores');
            teamScores.innerHTML = '';
            const settingsMenu = document.getElementById('settings-menu');
            //Only remove team name inputs
            Array.from(settingsMenu.querySelectorAll('input[id^="team"]')).forEach(input => input.remove());

            for (let i = 0; i < arr.length; i++) {
                // Team-Div
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team';
                teamDiv.id = `team${i+1}`;
                teamDiv.innerHTML = `Team ${i+1}: <span id="score${i+1}">${arr[i]}</span>`;
                teamScores.appendChild(teamDiv);

                // Input field for team name
                const teamInput = document.createElement('input');
                teamInput.type = 'text';
                teamInput.id = `team${i+1}-name`;
                teamInput.placeholder = `Enter Team ${i+1} Name`;
                document.getElementById('team-inputs').appendChild(teamInput);

                // Live update team name
                teamInput.addEventListener('input', function() {
                    const teamDiv = document.getElementById(`team${i+1}`);
                    if (teamDiv) {
                        teamDiv.innerHTML = `${this.value || 'Team ' + (i+1)}: <span id="score${i+1}">${scores[i] || 0}</span>`;
                    }
                });
            }

            // update score array
            for (let i = 0; i < arr.length; i++) {
                scores[i] = arr[i];
            }
        } else {
            // if no saved scores, initialize with 4 teams
            teamCount = 4;
        }

        function handleQuestionClick(questionDiv) {
            const popup = document.getElementById('popup');
            const overlay = document.getElementById('overlay');
            const content = document.getElementById('popup-content');
            const buttons = document.getElementById('popup-buttons');
            const toggleButton = document.getElementById('toggle-answer-button');

            // Retrieve data from the clicked question div
            const points = parseInt(questionDiv.dataset.points);
            popup.dataset.points = points; // Set the points on the popup for later use
            const question = questionDiv.dataset.question;
            const answer = questionDiv.dataset.answer;

            currentQuestion = question;
            currentAnswer = answer;
            currentQuestionObj = questionDiv.questionObj || null;

            // Collect hints and sort them
            currentHints = [];
            if (currentQuestionObj) {
                currentHints = Object.keys(currentQuestionObj)
                    .filter(key => key.startsWith('hint'))
                    .sort()
                    .map(key => currentQuestionObj[key]);
            }
            currentHintIndex = 0;

            content.innerHTML = currentQuestion.replace(/\n/g, '<br>'); // Replace \n with <br>
            buttons.innerHTML = '';

            // Display hint-button only if hints are available
            if (currentHints.length > 0) {
                const hintButton = document.createElement('button');
                hintButton.textContent = 'Hinweis anzeigen';
                hintButton.onclick = function() {
                    if (currentHintIndex < currentHints.length) {
                        let hintDiv = document.getElementById('hint-div');
                        if (!hintDiv) {
                            hintDiv = document.createElement('div');
                            hintDiv.id = 'hint-div';
                            hintDiv.className = 'hint';
                            content.appendChild(hintDiv);
                        }
                        // Append the new hint
                        const hintHtml = `<div><b>Hinweis:</b> ${currentHints[currentHintIndex]}</div>`;
                        hintDiv.innerHTML += hintHtml;
                        currentHintIndex++;
                        if (currentHintIndex >= currentHints.length) {
                            hintButton.disabled = true;
                            hintButton.textContent = 'Keine weiteren Hinweise';
                        }
                    }
                };
                buttons.appendChild(hintButton);
            }

            toggleButton.textContent = 'Antwort';

            popup.style.display = 'block';
            overlay.style.display = 'block';
        }

        function toggleAnswer() {
            const content = document.getElementById('popup-content');
            const buttons = document.getElementById('popup-buttons');
            const toggleButton = document.getElementById('toggle-answer-button');

            if (!showingAnswer) {
                content.innerHTML = currentAnswer.replace(/\n/g, '<br>');
                buttons.innerHTML = '';
                for (let i = 1; i <= teamCount; i++) {
                    const teamName = document.getElementById(`team${i}`).textContent.split(':')[0];
                    const button = document.createElement('button');
                    button.textContent = teamName;
                    button.onclick = () => {
                        updateScore(i, parseInt(document.querySelector('.popup').dataset.points));
                        closePopup();
                    };
                    buttons.appendChild(button);
                }
                toggleButton.textContent = 'Frage';
            } else {
                // Display Question and reset hints
                handleQuestionClick(document.querySelector(`.question[data-question="${currentQuestion}"][data-points="${document.querySelector('.popup').dataset.points}"]`));
            }

            showingAnswer = !showingAnswer;
        }

        function updateScore(team, points) {
            scores[team - 1] += points;
            document.getElementById(`score${team}`).textContent = scores[team - 1];

            // Save points to cookie
            setCookie('scores', JSON.stringify(scores));

            // Make the question div gray and save its status
            const questionDivs = document.querySelectorAll('.question');
            questionDivs.forEach(div => {
                if (div.dataset.question === currentQuestion) {
                    div.classList.add('answered');
                    // Save unique ID for question
                    const qid = div.dataset.question + '|' + div.dataset.points;
                    if (!answeredQuestions.includes(qid)) {
                        answeredQuestions.push(qid);
                        setCookie('answeredQuestions', JSON.stringify(answeredQuestions));
                    }
                }
            });

            closePopup();
        }

        function closePopup() {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            showingAnswer = false; // Reset to allow the next question to show
        }

        function toggleDarkMode() {
            const currentTheme = document.documentElement.getAttribute("data-theme");
            if (currentTheme === "dark") {
                document.documentElement.setAttribute("data-theme", "light");
            } else {
                document.documentElement.setAttribute("data-theme", "dark");
            }
        }

        function toggleSettingsMenu() {
            const menu = document.getElementById("settings-menu");
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        }

        function toggleInfoMenu() {
            const menu = document.getElementById("info-menu");
            menu.style.display = menu.style.display === "block" ? "none" : "block";
        }

        function updateTeamNames() {
            for (let i = 1; i <= teamCount; i++) {
                const teamNameInput = document.getElementById(`team${i}-name`);
                const teamName = teamNameInput.value;
                if (teamName) {
                    document.getElementById(`team${i}`).innerHTML = `${teamName}: <span id="score${i}">${scores[i - 1] || 0}</span>`;
                }
            }

            toggleSettingsMenu(); // Close the settings menu after updating
        }

        function updateQuizTitle() {
            const titleInput = document.getElementById('quiz-title-input');
            const newTitle = titleInput.value.trim();
            if (newTitle) {
                document.title = newTitle;
                document.querySelector('h1').textContent = newTitle;
                setCookie('quizTitle', newTitle);
            }
        }

        // On page load, restore title if saved
        const savedTitle = getCookie('quizTitle');
        if (savedTitle) {
            document.title = savedTitle;
            document.querySelector('h1').textContent = savedTitle;
        }

        function addTeam() {
            if (teamCount >= 10) {
                alert("Maximum of 10 teams allowed.");
                return;
            }

            teamCount++;
            scores.push(0); // Add a new score entry for the new team

            // Add to the team-scores div
            const teamScores = document.querySelector('.team-scores');
            const newTeamDiv = document.createElement('div');
            newTeamDiv.className = 'team';
            newTeamDiv.id = `team${teamCount}`;
            newTeamDiv.innerHTML = `Team ${teamCount}: <span id="score${teamCount}">0</span>`;
            teamScores.appendChild(newTeamDiv);

            // Add to the team-inputs div in the settings menu
            const teamInputsDiv = document.getElementById('team-inputs');
            const newTeamInput = document.createElement('input');
            newTeamInput.type = 'text';
            newTeamInput.id = `team${teamCount}-name`;
            newTeamInput.placeholder = `Enter Team ${teamCount} Name`;
            teamInputsDiv.appendChild(newTeamInput);

            // Live update team name
            newTeamInput.addEventListener('input', function() {
                const teamDiv = document.getElementById(`team${teamCount}`);
                if (teamDiv) {
                    teamDiv.innerHTML = `${this.value || 'Team ' + (teamCount)}: <span id="score${teamCount}">${scores[teamCount - 1] || 0}</span>`;
                }
            });

            setCookie('scores', JSON.stringify(scores));
        }

        function removeTeam() {
            if (teamCount <= 1) {
                alert("At least one team is required.");
                return;
            }

            // Remove the last team from the scores section
            const lastTeamDiv = document.getElementById(`team${teamCount}`);
            lastTeamDiv.remove();

            // Remove the corresponding input field from the settings menu
            const lastTeamInput = document.getElementById(`team${teamCount}-name`);
            lastTeamInput.remove();

            scores.pop(); // Remove the last score entry
            teamCount--;

            // save updated scores to cookie
            setCookie('scores', JSON.stringify(scores));
        }

        function resetScores() {
            for (let i = 0; i < teamCount; i++) {
                scores[i] = 0;
                const scoreSpan = document.getElementById(`score${i+1}`);
                if (scoreSpan) scoreSpan.textContent = 0;
            }
            setCookie('scores', JSON.stringify(scores));

            // Reset answered questions
            answeredQuestions = [];
            setCookie('answeredQuestions', JSON.stringify(answeredQuestions));
            document.querySelectorAll('.question.answered').forEach(div => div.classList.remove('answered'));
            toggleSettingsMenu(); // Close the settings menu after resetting
        }

        function deleteQuestionsCookie() {
            // Delete the questions cookie
            sessionStorage.removeItem('questions');
            resetScores(); // Reset scores and answered questions
            toggleSettingsMenu(); // Close the settings menu after deleting
            location.reload(); // Reload the page to refresh the board
        }

        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                closePopup(); // Call the existing closePopup function
            }
        });

        const savedQuestions = sessionStorage.getItem('questions');
        if (savedQuestions) {
            populateQuestions(JSON.parse(savedQuestions));
        } else {
            fetch('question.json')
                .then(response => response.json())
                .then(data => {
                    populateQuestions(data);
                });
        }

        function populateQuestions(data) {
            const board = document.querySelector('.jeopardy-board');
            board.innerHTML = '';

            const categories = Object.keys(data);
            categories.forEach(category => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                if (category.length > 12) categoryDiv.classList.add('adjust-font-size');
                categoryDiv.textContent = category;
                board.appendChild(categoryDiv);
            });

            const maxQuestions = Math.max(...categories.map(category => data[category].length));
            for (let i = 0; i < maxQuestions; i++) {
                categories.forEach(category => {
                    const question = data[category][i];
                    if (question) {
                        const questionDiv = document.createElement('div');
                        questionDiv.className = 'question';
                        questionDiv.textContent = question.points;
                        questionDiv.questionObj = question;
                        questionDiv.dataset.question = question.question;
                        questionDiv.dataset.answer = question.answer;
                        questionDiv.dataset.points = question.points;
                        questionDiv.onclick = () => handleQuestionClick(questionDiv);

                        // Add right-click event to mark as answered without giving points
                        questionDiv.oncontextmenu = function(e) {
                            e.preventDefault();
                            questionDiv.classList.add('answered');
                            const qid = question.question + '|' + question.points;
                            if (!answeredQuestions.includes(qid)) {
                                answeredQuestions.push(qid);
                                setCookie('answeredQuestions', JSON.stringify(answeredQuestions));
                            }
                            return false;
                        };

                        // When the question is a guess question, add a special class
                        if (question.guess === true) {
                            questionDiv.classList.add('guess-question');
                        }

                        // Check if the question has been answered
                        const qid = question.question + '|' + question.points;
                        if (answeredQuestions.includes(qid)) {
                            questionDiv.classList.add('answered');
                        }

                        board.appendChild(questionDiv);
                    } else {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'question';
                        emptyDiv.style.visibility = 'hidden';
                        board.appendChild(emptyDiv);
                    }
                });
            }
        }

        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days*24*60*60*1000).toUTCString();
            document.cookie = `${name}=${encodeURIComponent(value)}; expires=${expires}; path=/`;
        }

        function getCookie(name) {
            const value = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
            return value ? decodeURIComponent(value.pop()) : null;
        }

        // Drag & Drop for loading question.json
        document.addEventListener('dragover', function(e) {
            e.preventDefault();
            document.body.style.background = "#222"; // Optional: visual feedback
        });
        document.addEventListener('dragleave', function(e) {
            e.preventDefault();
            document.body.style.background = ""; // Reset background
        });
        document.addEventListener('drop', function(e) {
            e.preventDefault();
            document.body.style.background = ""; // Reset background
        
            if (e.dataTransfer.files.length === 0) return;
            const file = e.dataTransfer.files[0];
            if (!file.name.endsWith('.json')) {
                alert('Please drop a .json file!');
                return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                sessionStorage.setItem('questions', JSON.stringify(data));
                populateQuestions(data);
            } catch (error) {
                alert('Error loading questions: ' + error.message);
            }
        };
        reader.readAsText(file);
    });
    </script>
</body>
</html>